<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Notes.txt®</title>
    <style>
        :root {
            --glass: rgba(255, 255, 255, 0.8);
            --border: rgba(255, 255, 255, 1);
            --accent: #007AFF;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: #f2f2f7;
            height: 100dvh;
            color: #1c1c1e;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Arrière-plan Liquid sans image */
        .bg-layer {
            position: fixed;
            inset: 0;
            z-index: -1;
            background: radial-gradient(circle at 20% 20%, #e5e5ea 0%, #f2f2f7 100%);
        }

        header {
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            background: var(--glass);
            padding: 40px 20px 15px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 { font-size: 18px; font-weight: 600; margin: 0; }

        .btn-auth {
            border: 1px solid #d1d1d6;
            background: #fff;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }

        #app {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            padding-bottom: 120px;
        }

        .note-card {
            background: #fff;
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            border: 1px solid rgba(0,0,0,0.05);
        }

        .todo-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 0;
        }

        .circle-check {
            width: 20px; height: 20px;
            border: 2px solid var(--accent);
            border-radius: 50%;
            flex-shrink: 0;
        }
        .circle-check.active { background: var(--accent); position: relative; }
        .circle-check.active::after {
            content: ""; position: absolute; left: 6px; top: 2px;
            width: 4px; height: 8px; border: solid white; border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }

        .dock {
            position: fixed;
            bottom: 30px; left: 50%;
            transform: translateX(-50%);
            width: 140px; height: 60px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border-radius: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 1px solid rgba(0,0,0,0.1);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .btn-add {
            width: 44px; height: 44px;
            background: var(--accent);
            border-radius: 50%;
            border: none;
            display: flex; align-items: center; justify-content: center;
            color: white; cursor: pointer;
        }

        #editor {
            position: fixed; inset: 0;
            background: #fff; z-index: 1000;
            display: none; flex-direction: column;
        }

        textarea {
            flex: 1; border: none; padding: 20px;
            font-size: 17px; outline: none; font-family: inherit;
        }

        .bar { padding: 40px 20px 10px; display: flex; justify-content: space-between; }
        .btn-text { background: none; border: none; color: var(--accent); font-size: 17px; cursor: pointer; }
    </style>
</head>
<body>

<div class="bg-layer"></div>

<header>
    <h1>Notes.txt®</h1>
    <button id="loginBtn" class="btn-auth">Connexion</button>
</header>

<main id="app">
    </main>

<div class="dock">
    <button class="btn-add" id="openEditorBtn">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
    </button>
</div>

<div id="editor">
    <div class="bar">
        <button id="cancelBtn" class="btn-text">Annuler</button>
        <button id="saveBtn" class="btn-text" style="font-weight:600;">Enregistrer</button>
    </div>
    <textarea id="noteInput" placeholder="Nouvelle note..."></textarea>
    <div style="padding: 20px; border-top: 1px solid #f2f2f7;">
        <label style="display: flex; align-items: center; gap: 10px;">
            <input type="checkbox" id="todoToggle" style="width:20px; height:20px;"> Mode Liste
        </label>
    </div>
</div>

<script type="module">
    // Importation directe pour éviter les bugs de chargement
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, where, onSnapshot, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyALatpUtuY2BsFrGf_DTrE3nQnjQHi5MwY",
        authDomain: "gamesplatform-badcc.firebaseapp.com",
        projectId: "gamesplatform-badcc",
        storageBucket: "gamesplatform-badcc.firebasestorage.app",
        messagingSenderId: "677067722584",
        appId: "1:677067722584:web:537a6b1e919c82be0fdf2d"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    let user = null;

    // --- ACTIONS BOUTONS ---
    const loginBtn = document.getElementById('loginBtn');
    const openBtn = document.getElementById('openEditorBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const saveBtn = document.getElementById('saveBtn');
    const editor = document.getElementById('editor');

    loginBtn.addEventListener('click', () => {
        signInWithPopup(auth, provider).catch(err => alert("Erreur: " + err.message));
    });

    openBtn.addEventListener('click', () => {
        editor.style.display = 'flex';
        document.getElementById('noteInput').focus();
    });

    cancelBtn.addEventListener('click', () => {
        editor.style.display = 'none';
        document.getElementById('noteInput').value = '';
    });

    saveBtn.addEventListener('click', async () => {
        const text = document.getElementById('noteInput').value;
        const isTodo = document.getElementById('todoToggle').checked;
        if (!text) return;

        const noteData = {
            text,
            isTodo,
            uid: user ? user.uid : 'local',
            date: Date.now()
        };

        if (user) {
            await addDoc(collection(db, "notes"), noteData);
        } else {
            const local = JSON.parse(localStorage.getItem('notes_v4') || '[]');
            local.unshift({...noteData, id: Date.now()});
            localStorage.setItem('notes_v4', JSON.stringify(local));
            refreshUI();
        }

        editor.style.display = 'none';
        document.getElementById('noteInput').value = '';
    });

    // --- MISE À JOUR INTERFACE ---
    onAuthStateChanged(auth, (u) => {
        user = u;
        loginBtn.textContent = u ? u.displayName.split(' ')[0] : 'Connexion';
        refreshUI();
    });

    function refreshUI() {
        if (user) {
            const q = query(collection(db, "notes"), where("uid", "==", user.uid));
            onSnapshot(q, (snapshot) => {
                const notes = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                render(notes);
            });
        } else {
            render(JSON.parse(localStorage.getItem('notes_v4') || '[]'));
        }
    }

    function render(notes) {
        const container = document.getElementById('app');
        container.innerHTML = '';
        notes.sort((a,b) => b.date - a.date).forEach(n => {
            const card = document.createElement('div');
            card.className = 'note-card';
            
            let content = n.isTodo ? n.text.split('\n').map(line => `
                <div class="todo-item">
                    <div class="circle-check"></div>
                    <span>${line}</span>
                </div>
            `).join('') : `<div style="white-space:pre-wrap;">${n.text}</div>`;

            card.innerHTML = content;
            // Option supprimer sur appui long ou bouton simple
            card.addEventListener('contextmenu', async (e) => {
                e.preventDefault();
                if(confirm("Supprimer la note ?")) {
                    if(user) await deleteDoc(doc(db, "notes", n.id));
                    else {
                        const local = JSON.parse(localStorage.getItem('notes_v4')).filter(note => note.id !== n.id);
                        localStorage.setItem('notes_v4', JSON.stringify(local));
                        refreshUI();
                    }
                }
            });
            container.appendChild(card);
        });
    }

    refreshUI();
</script>
</body>
</html>